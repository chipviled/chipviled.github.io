'use strict';

if (console.log === undefined) console.log = function () {};
console.log('%c                               \n   Are you like web console?   \n                               ', 'color:#FFFFFF;background-color:#993399;');

function template_iteration(data) {
    var source = '\n    <div class="iteration" data-id="{{id}}">\n      <div class="iteration_title">\n       <div class="iteration_name">{{theme}}</div>\n       <div class="iteration_date">{{date_begin}} - {{date_end}}</div>\n      </div>\n      <div class="iteration_body">\n      \n        {{#each pictures}}\n            <div class="picture" data-id="{{id}}">\n              <div class="picture_body">\n                  <img src="./data/upload/{{file_path}}/thumb_{{file_name}}" title="{{title}}">\n              </div>\n              <div class="picture_title">{{title}}</div>\n              <div class="picture_username">\n                <a href="//sonic-world.ru/forum/user/{{user_sity_id}}-{{user_name}}">{{user_name}}</a>\n              </div>\n            </div>\n        {{/each}}\n        \n      </div>\n    </div>\n    ';
    var template = Handlebars.compile(source);
    return template(data);
}

// TODO: Create this with for.
jQuery.when(jQuery.getJSON('./data/json/picture.json'), jQuery.getJSON('./data/json/users.json'), jQuery.getJSON('./data/json/iteration.json'), jQuery.getJSON('./data/json/achivement.json'), jQuery.getJSON('./data/json/user_achivement.json'), jQuery.getJSON('./data/json/user_vote.json')).done(function (picture, users, iteration, achivement, user_achivement, user_vote) {
    var data = {
        picture: picture[0],
        users: users[0],
        iteration: iteration[0],
        achivement: achivement[0],
        user_achivement: user_achivement[0],
        user_vote: user_vote[0]
    };

    work(data);
}).fail(function (e) {
    console.log('Error from load data.', e);
});

function work(data) {

    var template_iterations = jQuery('.iterations');
    var iterations_data = alasql('\n        SELECT i.*\n        FROM ? i\n        ORDER BY i.date_begin DESC\n        ', [data.iteration]);

    template_iterations.text('');

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
        for (var _iterator = iterations_data[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var row_i = _step.value;

            var pistures_data = alasql('\n            SELECT p.*, u.name AS user_name, u.sity_id AS user_sity_id\n            FROM ? p\n            LEFT JOIN ? u ON u.id = p.user_id\n            WHERE p.iteration_id = ?\n            ORDER BY p.id\n            ', [data.picture, data.users, row_i.id]);

            row_i.pictures = pistures_data;

            var t_object = jQuery(template_iteration(row_i));

            template_iterations.append(t_object);
        }
    } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
    } finally {
        try {
            if (!_iteratorNormalCompletion && _iterator.return) {
                _iterator.return();
            }
        } finally {
            if (_didIteratorError) {
                throw _iteratorError;
            }
        }
    }
}